// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
  // directUrl eliminado para evitar error en local
}

enum UserRole {
  ADMIN
  PARTICULAR
  AGENCIA
  DIFUSOR
}

// prisma/schema.prisma

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  name          String?   // Nombre Personal (Juan Pérez)
  surname       String?
  
  // --- IDENTIDAD VISUAL ---
  avatar        String?   // FOTO PERSONAL (Cara del agente)
  coverImage    String?   // FONDO DE PERFIL (Agencia)
  
  // --- DATOS CORPORATIVOS (Separados de los personales) ---
  role          UserRole  @default(PARTICULAR)
  companyName   String?   // Nombre Comercial (InmoLuxury)
  companyLogo   String?   // LOGO EMPRESA (Diferente al avatar)
  cif           String?
  licenseNumber String?
  licenseType   String?   @default("STARTER") // Nivel de Suscripción
  
  // --- CONTACTO Y ZONA ---
  phone         String?   // Fijo
  mobile        String?   // Móvil directo
  website       String?
  tagline       String?   // Eslogan (ej: "Líderes en Costa del Sol")
  zone          String?   // Zona operativa (ej: "Marbella")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  properties    Property[]
  favorites     Favorite[]
}

model Property {
  id                String    @id @default(cuid())
  userId            String?
  user              User?     @relation(fields: [userId], references: [id])

  // Ubicación
  address           String
  city              String?
  region            String?
  postcode          String?
  latitude          Float?
  longitude         Float?

  // Detalles Básicos
  type              String    @default("Piso")
  floor             String?
  door              String?
  elevator          Boolean   @default(false)
  state             String?
  mBuilt            Float
  rooms             Int
  baths             Int

  // Amenities
  pool              Boolean   @default(false)
  garage            Boolean   @default(false)
  terrace           Boolean   @default(false)
  garden            Boolean   @default(false)
  storage           Boolean   @default(false)
  ac                Boolean   @default(false)
  security          Boolean   @default(false)
  exterior          Boolean   @default(true)

  // Datos Comerciales
  title             String?
  description       String?   @db.Text
  price             Float?
  communityFees     Float?

  // Energía
  energyConsumption String?
  energyEmissions   String?
  energyPending     Boolean   @default(false)

  // Multimedia y Servicios
  mainImage         String?
  images            Image[]
  selectedServices  String[]
  serviceOrders     ServiceOrder[]

  // Estado Sistema
  status            String    @default("BORRADOR")
  views             Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relaciones
  favoritedBy       Favorite[]

  // --- NUEVO: snapshot con la identidad/branding del creador ---
  ownerSnapshot     Json?     // { id, name, companyName, companyLogo, avatar, phone, mobile, coverImage, tagline, role }
}

model Image {
  id         String   @id @default(cuid())
  url        String
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model ServiceOrder {
  id         String   @id @default(cuid())
  serviceId  String
  name       String
  price      Float
  paid       Boolean  @default(false)
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
}

model Favorite {
  id         String   @id @default(cuid())
  userId     String
  propertyId String
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id])
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
}
