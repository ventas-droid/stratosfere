// --------------------------------------------------------
// 1. PROTOCOLO ACERO: MOTOR BLINDADO (FUSI칍N V3)
// --------------------------------------------------------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_URL")
  // TRUCO: Usamos la misma variable dos veces para desbloquear su ordenador
  directUrl = env("POSTGRES_URL") 
}

// 1. DEFINICI칍N DE RANGOS
enum UserRole {
  ADMIN        // Usted (Control Total)
  PARTICULAR   // Civil: Vende su propia casa
  AGENCIA      // Profesional: Inmobiliaria con CIF y local
  DIFUSOR      // T치ctico: Personal Shopper, Freelance, Influencer
}

// 2. MODELO DE USUARIO UNIFICADO (Con Datos Profesionales Opcionales)
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?   // La "Llave" de acceso
  
  // Identidad B치sica
  name          String?   // Nombre de pila (Isidro)
  surname       String?   // Apellidos (Bernabeu)
  phone         String?   
  avatar        String?   
  
  // 游댠 RANGO MILITAR
  role          UserRole  @default(PARTICULAR)

  // 游끽 DATOS DE EMPRESA (Opcionales - Solo para Agencia/Difusor)
  companyName   String?   // "Inmobiliaria Mar Azul S.L."
  cif           String?   // Identificaci칩n Fiscal
  website       String?   // Web externa
  licenseNumber String?   // N췈 de Colegiado (si aplica)

  // Auditor칤a
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  properties    Property[]
  favorites     Favorite[]
}

// --------------------------------------------------------
// 3. EL ACTIVO INMOBILIARIO (FULL EQUIP)
// --------------------------------------------------------

model Property {
  id            String    @id @default(cuid())
  
  // RELACI칍N USUARIO (Opcional por ahora para que no falle al crear sin login)
  userId        String?   
  user          User?     @relation(fields: [userId], references: [id])

  // --- PASO 1: UBICACI칍N ---
  address       String    
  city          String?   
  region        String?   // <--- RECUPERADO
  postcode      String?   // <--- RECUPERADO (zipCode)
  latitude      Float?    
  longitude     Float?    

  // --- PASO 2: CARACTER칈STICAS ---
  type          String    @default("Piso") // Usamos String para evitar errores de Enum con "츼tico" vs "ATICO"
  floor         String?   
  door          String?   
  elevator      Boolean   @default(false) 
  state         String?   // <--- RECUPERADO (Buen estado, A reformar...)

  // --- PASO 3: ESPECIFICACIONES ---
  mBuilt        Float     // Cambiado a Float por si ponen decimales
  rooms         Int       
  baths         Int       
  
  // EXTRAS F칈SICOS (Booleans para filtros r치pidos)
  pool          Boolean   @default(false)
  garage        Boolean   @default(false)
  terrace       Boolean   @default(false)
  garden        Boolean   @default(false)
  storage       Boolean   @default(false)
  ac            Boolean   @default(false) 
  security      Boolean   @default(false)
  exterior      Boolean   @default(true) // <--- RECUPERADO

  // --- PASO 4: NARRATIVA ---
  title         String?   
  description   String?   @db.Text 

  // --- PASO 5: ENERG칈A (HUECOS NUEVOS) ---
  energyConsumption String? // Letra A-G
  energyEmissions   String? // Letra A-G
  energyPending     Boolean @default(false)

  // --- PASO 6: MULTIMEDIA ---
  mainImage     String?   
  images        Image[]

  // --- PASO 7: VALORACI칍N ---
  price         Float?    
  communityFees Float?    // <--- 춰EL CAMPO QUE FALTABA!

  // --- PASO 8: ESTRATEGIA (LA CLAVE) ---
  // Guardamos un array simple de Strings para que el Formulario (ArchitectHud)
  // pueda leer/escribir r치pido ("foto", "pack_pro", "drone") sin complicaciones.
  selectedServices String[] 
  
  // Y MANTENEMOS SU TABLA DE 칍RDENES PARA EL FUTURO (Hist칩rico de pagos)
  serviceOrders ServiceOrder[]

  // --- ESTADO ---
  status        String    @default("BORRADOR") // String es m치s seguro para borradores r치pidos
  views         Int       @default(0) 
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  favoritedBy   Favorite[]
}

// --------------------------------------------------------
// 4. TABLAS AUXILIARES
// --------------------------------------------------------

model Image {
  id         String   @id @default(cuid())
  url        String   
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model ServiceOrder {
  id         String   @id @default(cuid())
  serviceId  String   
  name       String   
  price      Float    
  paid       Boolean  @default(false)
  
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now())
}

model Favorite {
  id         String   @id @default(cuid())
  userId     String
  propertyId String
  
  user       User     @relation(fields: [userId], references: [id])
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
}